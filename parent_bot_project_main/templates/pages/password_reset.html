{% load static %}
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>비밀번호 찾기 - 베이비가이드</title>

    <link rel="icon" type="image/png" href="{% static 'img/logo.png' %}" />
    <link rel="stylesheet" href="{% static 'css/global.css' %}" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  </head>
  <body>
    {% include 'partials/header.html' %}

    <!-- 메인 -->
    <main class="join">
      <div class="container join__grid">
        <!-- 왼쪽 카드 -->
        <section class="join__card">
          <h1 class="join__title">비밀번호 찾기</h1>
          
          <!-- 단계 1: 이메일 인증 -->
          <div id="step1" style="display: block;">
            <p style="color:#888; margin-bottom:20px;">가입 시 사용한 이메일을 입력해주세요.</p>
            
            <label for="email" class="join__label">이메일 인증</label>
            <div class="join__input-row">
              <input id="email" type="email" required class="join__input" placeholder="user@domain.com" />
              <button type="button" id="emailSendBtn" class="btn btn--ghost join__check-btn">인증 요청</button>
            </div>
            <small id="emailError" style="color:red; display:none; margin-top:4px;"></small>

            <!-- 인증번호 입력 -->
            <label for="emailCodeInput" class="join__label" style="margin-top:12px;">인증번호 입력</label>
            <div class="join__input-row">
              <input id="emailCodeInput" type="text" class="join__input" placeholder="인증번호 6자리" maxlength="6" inputmode="numeric" />
              <button type="button" id="emailVerifyBtn" class="btn btn--ghost join__check-btn">인증 확인</button>
            </div>
            <small id="codeError" style="color:red; display:none; margin-top:4px;"></small>
          </div>

          <!-- 단계 2: 비밀번호 재설정 -->
          <div id="step2" style="display: none;">
            <p style="color:#888; margin-bottom:20px;">새로운 비밀번호를 설정해주세요.</p>
            
            <form method="post" action="{% url 'password_reset' %}">
              {% csrf_token %}
              <input type="hidden" id="emailHidden" name="email" value="">

              <label for="newPassword" class="join__label">새로운 비밀번호</label>
              <input id="newPassword" type="password" name="password"
                required minlength="10" class="join__input"
                placeholder="영어+숫자+특수문자 10자 이상"
                pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[^A-Za-z0-9]).{10,}$"
                title="10자 이상, 영문/숫자/특수문자 포함" />

              <label for="newPassword2" class="join__label">비밀번호 확인</label>
              <input id="newPassword2" type="password" required class="join__input" placeholder="비밀번호 재입력" />

              <button type="submit" class="btn btn--cta join__submit">변경</button>
            </form>
          </div>

          {% if error %}
            <p style="color:red; margin-top:12px;">{{ error }}</p>
          {% endif %}

          <!-- 링크 -->
          <div class="join__links" style="margin-top:24px;">
            <a href="{% url 'login' %}" class="join__link">로그인으로 돌아가기</a>
          </div>
        </section>

        <!-- 오른쪽 이미지 -->
        <figure class="join__figure">
          <img src="{% static 'img/join_red.jpg' %}" alt="비밀번호 찾기 이미지" class="join__image" loading="lazy" />
        </figure>
      </div>
    </main>

    {% include 'partials/footer.html' %}

    <!-- 모달 -->
    <div id="appModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal__backdrop" data-close-modal></div>
      <div class="modal__panel">
        <h3 id="modalTitle" class="modal__title">알림</h3>
        <div id="modalMessage" class="modal__body">메시지</div>
        <div class="modal__actions">
          <button type="button" class="modal__btn" data-close-modal>확인</button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        /* =========================
           공통: CSRF / 유틸
        ==========================*/
        function getCookie(name) {
          const m = document.cookie.match(new RegExp('(^|; )' + name + '=([^;]*)'));
          return m ? decodeURIComponent(m[2]) : null;
        }
        const CSRF = getCookie('csrftoken') ||
                     document.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';
      
        const $ = (sel) => document.querySelector(sel);
      
        /* =========================
           모달 헬퍼
        ==========================*/
        const modal      = $('#appModal');
        const modalMsg   = $('#modalMessage');
        const modalTitle = $('#modalTitle');
      
        function openModal(message, title='알림') {
          modalTitle.textContent = title;
          modalMsg.textContent   = message;
          modal.classList.add('modal--open');
          document.documentElement.style.overflow = 'hidden';
          modal.querySelector('[data-close-modal]')?.focus();
        }
        function closeModal() {
          modal.classList.remove('modal--open');
          document.documentElement.style.overflow = '';
        }
        modal.addEventListener('click', (e) => {
          if (e.target.matches('[data-close-modal]')) closeModal();
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeModal();
        });
      
        /* =========================
           요소 참조
        ==========================*/
        const emailInput      = $('#email');
        const emailHidden     = $('#emailHidden');
        const emailError      = $('#emailError');
        const codeInput       = $('#emailCodeInput');
        const codeError       = $('#codeError');
        const btnEmailSend    = $('#emailSendBtn');
        const btnEmailVerify  = $('#emailVerifyBtn');
        const step1           = $('#step1');
        const step2           = $('#step2');
        const newPwInput      = $('#newPassword');
        const newPw2Input     = $('#newPassword2');
        const form            = document.querySelector('form');
      
        /* =========================
           정규식(클라이언트 검증)
        ==========================*/
        const PW_RE = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[^A-Za-z0-9]).{10,}$/;

        /* =========================
           에러 표시 헬퍼
        ==========================*/
        function showEmailError(msg) {
          emailError.textContent = msg;
          emailError.style.display = 'block';
        }
        function hideEmailError() {
          emailError.style.display = 'none';
        }
        function showCodeError(msg) {
          codeError.textContent = msg;
          codeError.style.display = 'block';
        }
        function hideCodeError() {
          codeError.style.display = 'none';
        }
      
        /* =========================
           이메일 인증 코드 전송
        ==========================*/
        btnEmailSend.addEventListener('click', async () => {
          const email = emailInput.value.trim().toLowerCase();
          hideEmailError();
          
          if (!email || !/@/.test(email) || !/\./.test(email)) {
            showEmailError('이메일 형식이 올바르지 않습니다.');
            return;
          }
      
          btnEmailSend.disabled = true;
          try {
            const formData = new FormData();
            formData.append('email', email);
      
            const res  = await fetch("{% url 'api_password_reset_send' %}", {
              method: 'POST',
              headers: { 'X-CSRFToken': CSRF },
              body: formData
            });
            const data = await res.json();
      
            if (data.ok) {
              hideEmailError();
              openModal('인증번호가 발송되었습니다. (5분 유효)');
            } else {
              showEmailError(data.reason || '전송 실패');
            }
          } catch {
            showEmailError('네트워크 오류가 발생했습니다.');
          } finally {
            btnEmailSend.disabled = false;
          }
        });
      
        /* =========================
           이메일 코드 검증
        ==========================*/
        btnEmailVerify.addEventListener('click', async () => {
          const email = emailInput.value.trim().toLowerCase();
          const code  = codeInput.value.trim();
          hideCodeError();
          
          if (!/^\d{6}$/.test(code)) {
            showCodeError('인증번호는 6자리 숫자입니다.');
            return;
          }
          btnEmailVerify.disabled = true;
          try {
            const formData = new FormData();
            formData.append('email', email);
            formData.append('code',  code);
      
            const res  = await fetch("{% url 'api_password_reset_verify' %}", {
              method: 'POST',
              headers: { 'X-CSRFToken': CSRF },
              body: formData
            });
            const data = await res.json();
      
            if (data.ok) {
              hideCodeError();
              emailHidden.value = email;
              openModal('이메일 인증이 완료되었습니다. 새 비밀번호를 설정하세요.');
              step1.style.display = 'none';
              step2.style.display = 'block';
            } else {
              showCodeError(data.reason || '인증 실패');
            }
          } catch {
            showCodeError('네트워크 오류가 발생했습니다.');
          } finally {
            btnEmailVerify.disabled = false;
          }
        });
      
        /* =========================
           폼 제출 전 최종 검증
        ==========================*/
        form?.addEventListener('submit', (e) => {
          const pw  = newPwInput.value;
          const pw2 = newPw2Input.value;
      
          if (!PW_RE.test(pw)) {
            e.preventDefault(); 
            openModal('비밀번호는 10자 이상, 영문/숫자/특수문자를 포함해야 합니다.'); 
            return;
          }
          if (pw !== pw2) {
            e.preventDefault(); 
            openModal('비밀번호 확인이 일치하지 않습니다.'); 
            return;
          }
        });
      });
    </script>
    
  </body>
</html>
