{% load static %}
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>베이비가이드</title>

    <link rel="icon" type="image/png" href="{% static 'img/logo.png' %}" />
    <link rel="stylesheet" href="{% static 'css/global.css' %}" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  </head>
  <body>
    {% include 'partials/header.html' %}

  <!-- 메인 -->
  <main class="join">
    <div class="container join__grid">
      <!-- 왼쪽 카드 -->
      <section class="join__card">
        <h1 class="join__title">회원가입</h1>
        <form method="post" action="{% url 'signup' %}">
          {% csrf_token %}

        <!-- 닉네임 -->
        <label for="nickname" class="join__label">닉네임</label>
        <div class="join__input-row">
          <input id="nickname" type="text" name="username" required class="join__input" placeholder="2~20자" pattern="^[A-Za-z0-9가-힣]{2,20}$" title="2~20자, 한글/영문/숫자만 허용" />
          <button type="button" id="nicknameCheckBtn" class="btn btn--ghost join__check-btn">중복 확인</button>
        </div>

        <!-- 이메일 -->
        <label for="email" class="join__label">이메일</label>
        <div class="join__input-row">
          <input id="email" type="email" name="email" required class="join__input" placeholder="user@domain.com" />
          <button type="button" id="emailSendBtn" class="btn btn--ghost join__check-btn">인증 요청</button>
        </div>
        <input type="hidden" id="emailHidden" value="">
        <small id="emailStatus" style="color:#888;">인증 미완료</small>

        <!-- 인증번호 -->
        <div class="join__input-row" style="margin-top:8px;">
          <input id="emailCodeInput" type="text" class="join__input" placeholder="인증번호 6자리" maxlength="6" inputmode="numeric" />
          <button type="button" id="emailVerifyBtn" class="btn btn--ghost join__check-btn">인증 확인</button>
        </div>

        <!-- 비밀번호 -->
        <label for="password" class="join__label">비밀번호</label>
        <input id="password" type="password" name="password"
          required minlength="10" class="join__input"
          placeholder="영어+숫자+특수문자 10자 이상"
          pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[^A-Za-z0-9]).{10,}$"
          title="10자 이상, 영문/숫자/특수문자 포함" />

        <!-- 비밀번호 확인 -->
        <label for="password2" class="join__label">비밀번호 확인</label>
        <input id="password2" type="password" name="password2" required class="join__input" placeholder="비밀번호 재입력" />

        <!-- 제출 -->
        <button type="submit" class="btn btn--cta join__submit">회원가입 완료</button>

        </form>
        {% if error %}
          <p style="color:red; margin-top:12px;">{{ error }}</p>
        {% endif %}

        <!-- 링크 -->
        <div class="join__links" style="margin-top:24px;">
          <span class="join__link" style="pointer-events:none; color:#c9b9b0;">이미 계정이 있으신가요?</span>
          <a href="{% url 'login' %}" class="join__link">로그인</a>
        </div>
      </section>

      <!-- 오른쪽 이미지 -->
      <figure class="join__figure">
        <img src="{% static 'img/join_red.jpg' %}" alt="회원가입 이미지" class="join__image" loading="lazy" />
      </figure>
    </div>
  </main>

  {% include 'partials/footer.html' %}

  <div id="appModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal__backdrop" data-close-modal></div>
    <div class="modal__panel">
      <h3 id="modalTitle" class="modal__title">알림</h3>
      <div id="modalMessage" class="modal__body">메시지</div>
      <div class="modal__actions">
        <button type="button" class="modal__btn" data-close-modal>확인</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      /* =========================
         공통: CSRF / 유틸
      ==========================*/
      function getCookie(name) {
        const m = document.cookie.match(new RegExp('(^|; )' + name + '=([^;]*)'));
        return m ? decodeURIComponent(m[2]) : null;
      }
      const CSRF = getCookie('csrftoken') ||
                   document.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';
    
      const $ = (sel) => document.querySelector(sel);
    
      /* =========================
         모달 헬퍼
      ==========================*/
      const modal      = $('#appModal');
      const modalMsg   = $('#modalMessage');
      const modalTitle = $('#modalTitle');
    
      function openModal(message, title='알림') {
        modalTitle.textContent = title;
        modalMsg.textContent   = message;
        modal.classList.add('modal--open');
        document.documentElement.style.overflow = 'hidden';
        modal.querySelector('[data-close-modal]')?.focus();
      }
      function closeModal() {
        modal.classList.remove('modal--open');
        document.documentElement.style.overflow = '';
      }
      modal.addEventListener('click', (e) => {
        if (e.target.matches('[data-close-modal]')) closeModal();
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
      });
    
      /* =========================
         요소 참조
      ==========================*/
      const nicknameInput   = $('#nickname');
      const emailInput      = $('#email');
      const emailHidden     = $('#emailHidden');
      const emailStatus     = $('#emailStatus');
      const codeInput       = $('#emailCodeInput');
      const pwInput         = $('#password');
      const pw2Input        = $('#password2');
      const btnNickCheck    = $('#nicknameCheckBtn');
      const btnEmailSend    = $('#emailSendBtn');
      const btnEmailVerify  = $('#emailVerifyBtn');
      const form            = document.querySelector('form');
    
      /* =========================
         정규식(클라이언트 검증)
      ==========================*/
      const NICK_RE = /^[A-Za-z0-9가-힣]{2,20}$/;
      const PW_RE   = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[^A-Za-z0-9]).{10,}$/; // \d 하나!
    
      /* =========================
         닉네임 중복 확인
      ==========================*/
      btnNickCheck.addEventListener('click', async () => {
        const name = nicknameInput.value.trim();
        if (!NICK_RE.test(name)) {
          openModal('닉네임은 2~20자, 한글/영문/숫자만 가능합니다.');
          return;
        }
        btnNickCheck.disabled = true;
        try {
          const res  = await fetch("{% url 'api_nickname_check' %}?username=" + encodeURIComponent(name));
          const data = await res.json();
          openModal(data.ok ? '사용 가능한 닉네임입니다.' : (data.reason || '사용할 수 없습니다.'));
        } catch {
          openModal('네트워크 오류가 발생했습니다.');
        } finally {
          btnNickCheck.disabled = false;
        }
      });
    
      // =========================
      // 이메일 인증 코드 전송
      // =========================
      btnEmailSend.addEventListener('click', async () => {
        const email = emailInput.value.trim().toLowerCase();
        if (!email || !/@/.test(email) || !/\./.test(email)) {
          openModal('이메일 형식이 올바르지 않습니다.');
          return;
        }

        // 프론트 즉시 가드(UX): 같은 이메일에 대해 완료/대기 상태면 막기
        const status = emailStatus.textContent.trim();
        if (emailHidden.value.toLowerCase() === email &&
            (status === '인증 완료' || status.startsWith('인증 메일 전송됨'))) {
          openModal(status === '인증 완료'
                    ? '이미 인증 완료된 이메일입니다.'
                    : '이미 전송되었습니다. 잠시 후 다시 시도하세요.');
          return;
        }

        btnEmailSend.disabled = true;
        try {
          const formData = new FormData();
          formData.append('email', email);

          const res  = await fetch("{% url 'api_send_email_code' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] },
            body: formData
          });
          const data = await res.json();

          if (data.ok) {
            emailHidden.value = email;
            emailStatus.textContent = '인증 메일 전송됨 (5분 유효)';
            openModal('인증번호가 발송되었습니다.');
          } else {
            if (data.blocked === 'registered') {
              // ★ DB에 이미 존재하는 이메일 → 처음부터 막기
              openModal('이미 인증된 이메일입니다. (가입된 이메일)');
              emailHidden.value = email;
              emailStatus.textContent = '인증 완료';
            } else if (data.blocked === 'verified') {
              openModal('이미 인증 완료된 이메일입니다.');
              emailHidden.value = email;
              emailStatus.textContent = '인증 완료';
            } else if (data.blocked === 'cooldown') {
              openModal(data.reason || '이미 전송되었습니다. 잠시 후 다시 시도하세요.');
              emailHidden.value = email;
              emailStatus.textContent = '인증 메일 전송됨 (대기중)';
            } else {
              openModal(data.reason || '전송 실패');
            }
          }
        } catch {
          openModal('네트워크 오류가 발생했습니다.');
        } finally {
          btnEmailSend.disabled = false;
        }
      });
    
      /* =========================
         이메일 코드 검증
      ==========================*/
      btnEmailVerify.addEventListener('click', async () => {
        const email = emailInput.value.trim();
        const code  = codeInput.value.trim();
        if (!/^\d{6}$/.test(code)) {
          openModal('인증번호는 6자리 숫자입니다.');
          return;
        }
        btnEmailVerify.disabled = true;
        try {
          const formData = new FormData();
          formData.append('email', email);
          formData.append('code',  code);
    
          const res  = await fetch("{% url 'api_verify_email_code' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF },
            body: formData
          });
          const data = await res.json();
    
          if (data.ok) {
            emailStatus.textContent = '인증 완료';
            openModal('이메일 인증이 완료되었습니다.');
          } else {
            emailStatus.textContent = data.reason || '인증 실패';
            openModal(data.reason || '인증 실패');
          }
        } catch {
          openModal('네트워크 오류가 발생했습니다.');
        } finally {
          btnEmailVerify.disabled = false;
        }
      });
    
      /* =========================
         폼 제출 전 최종 검증
      ==========================*/
      form.addEventListener('submit', (e) => {
        const name = nicknameInput.value.trim();
        const email = emailInput.value.trim();
        const pw  = pwInput.value;
        const pw2 = pw2Input.value;
    
        if (!NICK_RE.test(name)) {
          e.preventDefault(); openModal('닉네임은 2~20자, 한글/영문/숫자만 가능합니다.'); return;
        }
        if (!email || !/@/.test(email) || !/\./.test(email)) {
          e.preventDefault(); openModal('이메일 형식이 올바르지 않습니다.'); return;
        }
        if (!PW_RE.test(pw)) {
          e.preventDefault(); openModal('비밀번호는 10자 이상, 영문/숫자/특수문자를 포함해야 합니다.'); return;
        }
        if (pw !== pw2) {
          e.preventDefault(); openModal('비밀번호 확인이 일치하지 않습니다.'); return;
        }
        if (emailStatus.textContent.trim() !== '인증 완료') {
          // 프론트 가드(서버에서도 다시 체크함)
          e.preventDefault(); openModal('이메일 인증을 먼저 완료해주세요.'); return;
        }
      });
    });
    </script>
    
  </body>
</html>