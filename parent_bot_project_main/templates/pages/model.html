{% load static %}
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë² ì´ë¹„ê°€ì´ë“œ</title>

    <!-- ì •ë¦¬ëœ ë§í¬ë“¤ -->
    <link rel="icon" type="image/png" href="{% static 'img/logo.png' %}" />
    <link rel="stylesheet" href="{% static 'css/global.css' %}" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  </head>
  <body>
    {% include 'partials/header.html' %}

    <!-- íƒ€ì´í‹€ ë  -->
    <section class="chat__titlebar">
      <div class="chat__titlebar-inner">
        <h1 class="chat__title">
          ë„ë‹´ì´
          <img src="{% static 'img/dodam_image.png' %}" alt="ë„ë‹´ì´ ì´ë¯¸ì§€" class="chat__image" />
        </h1>
        <button id="saveTextBtn" class="btn btn--input_textfile">í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥</button>
      </div>
    </section>

    <!-- ë©”ì‹œì§€ ì˜ì—­ -->
    <main class="chat">
      <ol class="chat__messages" aria-live="polite">
        <!-- ì´ˆê¸° í™˜ì˜ ë©”ì‹œì§€ -->
        <li class="msg msg--bot">
          <div class="bubble-wrapper">
            <div class="bubble">
              ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ìœ¡ì•„ ë„ìš°ë¯¸ ë„ë‹´ì´ì˜ˆìš”. ğŸ¼<br>
              ê¶ê¸ˆí•œ ìœ¡ì•„ ì •ë³´ë‚˜ ë³‘ì›Â·ì•½êµ­ ì°¾ê¸° ë“± ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”!
            </div>
          </div>
        </li>
      </ol>
    </main>

    <!-- ì…ë ¥ì°½ -->
    <form class="composer" action="#" method="post">
      {% csrf_token %}
      <label class="sr-only" for="composerInput">ë©”ì‹œì§€ ì…ë ¥</label>
      <input id="composerInput" class="composer__input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" required />
      <button type="submit" class="btn btn--primary composer__send">ë³´ë‚´ê¸°</button>
    </form>

    <!-- íŒì—… ëª¨ë‹¬ -->
    <div id="saveModal" class="modal">
      <div class="modal-content">
        <h2 class="modal-title">ì•Œë¦¼</h2>
        <p class="modal-text">ë„ë‹´ì´ì™€ ë‚˜ëˆˆ ëŒ€í™”ê°€<br>txt íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        <button id="modalCloseBtn" class="btn btn--primary modal-btn">í™•ì¸</button>
      </div>
    </div>

  </div>


  <script>
    // ========== ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™” ==========
    // DOM ìš”ì†Œë“¤ì„ ë³€ìˆ˜ì— ì €ì¥ (ë°˜ë³µ ì‚¬ìš©í•˜ê¸° ìœ„í•´)
    const chatMessages = document.querySelector('.chat__messages');  // ë©”ì‹œì§€ ëª©ë¡ ì˜ì—­
    const composerForm = document.querySelector('.composer');  // ì…ë ¥ í¼
    const composerInput = document.getElementById('composerInput');  // ì…ë ¥ì°½
    const sendBtn = composerForm.querySelector('.composer__send');  // ì „ì†¡ ë²„íŠ¼
    const saveTextBtn = document.getElementById('saveTextBtn');  // í…ìŠ¤íŠ¸ ì €ì¥ ë²„íŠ¼
    const modal = document.getElementById('saveModal');  // ì €ì¥ ì™„ë£Œ ëª¨ë‹¬
    const modalCloseBtn = document.getElementById('modalCloseBtn');  // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
    
    // ëŒ€í™” ê¸°ë¡ì„ ì €ì¥í•˜ëŠ” ë°°ì—´ (ëŸ°íŒŸ APIì— ì»¨í…ìŠ¤íŠ¸ë¡œ ì „ë‹¬)
    let chatHistory = [];

    // ========== CSRF í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ ==========
    // Djangoì˜ CSRF ë³´ì•ˆì„ ìœ„í•´ ì¿ í‚¤ì—ì„œ í† í° ì¶”ì¶œ
    function getCSRFToken() {
      const cookies = document.cookie.split(';');  // ì¿ í‚¤ë¥¼ ì„¸ë¯¸ì½œë¡ ìœ¼ë¡œ ë¶„ë¦¬
      for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');  // ì´ë¦„=ê°’ í˜•íƒœë¡œ ë¶„ë¦¬
        if (name === 'csrftoken') return value;  // csrftoken ì°¾ìœ¼ë©´ ë°˜í™˜
      }
      return '';  // ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´
    }

    // ========== ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜ ==========
    // ì±„íŒ… ì°½ì— ì‚¬ìš©ì/ë´‡ ë©”ì‹œì§€ë¥¼ ë™ì ìœ¼ë¡œ ì¶”ê°€
    function addMessage(content, isUser = false) {
      const li = document.createElement('li');  // ìƒˆ li ìš”ì†Œ ìƒì„±
      li.className = isUser ? 'msg msg--user' : 'msg msg--bot';  // ì‚¬ìš©ì/ë´‡ êµ¬ë¶„
      li.innerHTML = `
        <div class="bubble-wrapper">
          <div class="bubble">${content}</div>
        </div>
      `;
      chatMessages.appendChild(li);  // ë©”ì‹œì§€ ëª©ë¡ì— ì¶”ê°€
      
      // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ìë™ ì´ë™ (ìµœì‹  ë©”ì‹œì§€ ë³´ì´ê²Œ)
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // ========== ë¡œë”© ì¸ë””ì¼€ì´í„° ì¶”ê°€ ==========
    // ë´‡ì´ ì‘ë‹µ ìƒì„± ì¤‘ì¼ ë•Œ "..." ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ
    function addLoadingIndicator() {
      const li = document.createElement('li');
      li.className = 'msg msg--bot msg--loading';
      li.id = 'loadingIndicator';  // IDë¡œ ë‚˜ì¤‘ì— ì œê±°í•˜ê¸° ìœ„í•´
      li.innerHTML = `
        <div class="bubble-wrapper">
          <div class="bubble typing-bubble">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      `;
      chatMessages.appendChild(li);
      chatMessages.scrollTop = chatMessages.scrollHeight;  // ìŠ¤í¬ë¡¤ ì´ë™
    }

    // ========== ë¡œë”© ì¸ë””ì¼€ì´í„° ì œê±° ==========
    // ë´‡ ì‘ë‹µì´ ë„ì°©í•˜ë©´ ë¡œë”© ì œê±°
    function removeLoadingIndicator() {
      const indicator = document.getElementById('loadingIndicator');
      if (indicator) indicator.remove();  // ìš”ì†Œ ì‚­ì œ
    }

    // ========== í¼ ì œì¶œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ==========
    // ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  ë•Œ ì‹¤í–‰
    composerForm.addEventListener('submit', async function(e) {
      e.preventDefault();  // í¼ ê¸°ë³¸ ë™ì‘(í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨) ë°©ì§€
      
      const question = composerInput.value.trim();  // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸° (ê³µë°± ì œê±°)
      if (!question) return;  // ë¹ˆ ê°’ì´ë©´ ë¬´ì‹œ

      // 1) ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— ì¶”ê°€
      addMessage(question, true);
      
      // 2) ëŒ€í™” ê¸°ë¡ì— ì¶”ê°€ (role: user)
      chatHistory.push({ role: 'user', content: question });
      
      // 3) ì…ë ¥ì°½ ì´ˆê¸°í™” ë° UI ë¹„í™œì„±í™” (ì¤‘ë³µ ì „ì†¡ ë°©ì§€)
      composerInput.value = '';
      composerInput.disabled = true;  // ì…ë ¥ ë¶ˆê°€
      sendBtn.disabled = true;  // ë²„íŠ¼ ë¹„í™œì„±í™”
      sendBtn.textContent = 'ì „ì†¡ ì¤‘...';  // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
      
      // 4) ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ
      addLoadingIndicator();

      try {
        // 5) Django ë°±ì—”ë“œ API í˜¸ì¶œ (AJAX)
        const response = await fetch('/api/chat/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',  // JSON í˜•ì‹
            'X-CSRFToken': getCSRFToken()  // CSRF í† í° í¬í•¨
          },
          body: JSON.stringify({
            question: question,  // í˜„ì¬ ì§ˆë¬¸
            history: chatHistory.slice(0, -1)  // ì´ì „ ëŒ€í™” ê¸°ë¡ (ë§ˆì§€ë§‰ ì§ˆë¬¸ ì œì™¸)
          })
        });

        const data = await response.json();  // ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹±
        
        // 6) ë¡œë”© ì¸ë””ì¼€ì´í„° ì œê±°
        removeLoadingIndicator();

        if (data.ok) {
          // ì„±ê³µ: ë´‡ ì‘ë‹µì„ ì±„íŒ…ì°½ì— ì¶”ê°€
          const answer = data.answer.replace(/\n/g, '<br>');  // ì¤„ë°”ê¿ˆ ì²˜ë¦¬
          addMessage(answer, false);
          
          // ëŒ€í™” ê¸°ë¡ì— ë´‡ ì‘ë‹µ ì¶”ê°€ (role: assistant)
          chatHistory.push({ role: 'assistant', content: data.answer });
        } else {
          // ì‹¤íŒ¨: ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
          addMessage(`âš ï¸ ì˜¤ë¥˜: ${data.error}`, false);
        }
      } catch (error) {
        // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“± ì˜ˆì™¸ ì²˜ë¦¬
        removeLoadingIndicator();
        addMessage(`âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, false);
      } finally {
        // 7) ì…ë ¥ì°½ ì¬í™œì„±í™” (í•­ìƒ ì‹¤í–‰)
        composerInput.disabled = false;
        sendBtn.disabled = false;
        sendBtn.textContent = 'ë³´ë‚´ê¸°';
        composerInput.focus();  // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
      }
    });

    // ========== í…ìŠ¤íŠ¸ íŒŒì¼ ì €ì¥ ê¸°ëŠ¥ ==========
    // "í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥" ë²„íŠ¼ í´ë¦­ ì‹œ
    saveTextBtn.addEventListener('click', function() {
      // 1) ëª¨ë“  ë©”ì‹œì§€ ìˆ˜ì§‘ (ë¡œë”© ì œì™¸)
      const messages = document.querySelectorAll('.msg:not(.msg--loading)');
      let textContent = '=== ë„ë‹´ì´ì™€ì˜ ëŒ€í™” ===\n\n';
      
      messages.forEach((msg) => {
        const bubble = msg.querySelector('.bubble');
        if (bubble) {
          const isUser = msg.classList.contains('msg--user');
          const sender = isUser ? 'ë‚˜' : 'ë„ë‹´ì´';  // ë°œì‹ ì êµ¬ë¶„
          const content = bubble.textContent.trim();  // ë©”ì‹œì§€ ë‚´ìš©
          textContent += `[${sender}]: ${content}\n\n`;
        }
      });
      
      // 2) Blob ìƒì„± (íŒŒì¼ ë°ì´í„°)
      const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
      const link = document.createElement('a');  // ì„ì‹œ ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
      link.href = URL.createObjectURL(blob);  // Blob URL ìƒì„±
      link.download = `ë„ë‹´ì´_ëŒ€í™”_${new Date().toISOString().split('T')[0]}.txt`;  // íŒŒì¼ëª… (ë‚ ì§œ í¬í•¨)
      link.click();  // ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
      URL.revokeObjectURL(link.href);  // ë©”ëª¨ë¦¬ í•´ì œ

      // 3) ì €ì¥ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ (ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼)
      modal.style.display = 'flex';
      setTimeout(() => modal.classList.add('show'), 10);  // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ì• ë‹ˆë©”ì´ì…˜
    });

    // ========== ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ ==========
    function closeModal() {
      modal.classList.remove('show');  // ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì œê±°
      setTimeout(() => modal.style.display = 'none', 300);  // 300ms í›„ ìˆ¨ê¹€
    }

    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ
    modalCloseBtn.addEventListener('click', closeModal);
    
    // ëª¨ë‹¬ ë°”ê¹¥ìª½ í´ë¦­ ì‹œ ë‹«ê¸°
    window.addEventListener('click', function(event) {
      if (event.target === modal) closeModal();
    });
  </script>

</body>
</html>
